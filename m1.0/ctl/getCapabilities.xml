<?xml version="1.0" encoding="UTF-8"?>
<ctl:package
  xmlns:getCapabilities="http://www.ioos.noaa.gov/sos/getCapabilities"
  xmlns:ctl="http://www.occamlab.com/ctl"
  xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
  xmlns:ows="http://www.opengis.net/ows/1.1" 
  xmlns:gml="http://www.opengis.net/gml" 
  xmlns:sos="http://www.opengis.net/sos/1.0"  
  xmlns:xml="http://www.w3.org/XML/1998/namespace"
  xmlns:ogc="http://www.opengis.net/ogc"
  xmlns:om="http://www.opengis.net/om/1.0"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema" 
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <ctl:test name="getCapabilities:allTests">
    <ctl:param name="capabilitiesDocument" />
    <ctl:assertion>GetCapabilities response is valid.</ctl:assertion>
    <ctl:code>
      <ctl:call-test name="getCapabilities:IOOS-SOS.GetCapabilities-ResponseContainsValidOperationsMetadataProperty.1">
        <ctl:with-param name="capabilitiesDocument" select="$capabilitiesDocument"/>
      </ctl:call-test>
      <ctl:call-test name="getCapabilities:IOOS-SOS.GetCapabilities-ResponseContainsValidOperationsMetadataProperty.2">
        <ctl:with-param name="capabilitiesDocument" select="$capabilitiesDocument"/>
      </ctl:call-test>
    </ctl:code>
  </ctl:test>

  <ctl:test name="getCapabilities:IOOS-SOS.GetCapabilities-ResponseContainsValidOperationsMetadataProperty.1">
    <ctl:param name="capabilitiesDocument" />
    <ctl:assertion>The operation names are listed in UpperCamelCase (i.e. GetCapabilities, DescribeSensor, GetObservation, other â€“ if implemented).</ctl:assertion>
    <ctl:code>
      <xsl:for-each select="$capabilitiesDocument/ows:OperationsMetadata/ows:Operation">
        <xsl:variable name="operationName" select="@name"/>
        <ctl:message select="concat('Checking operation ', $operationName)" />
        <xsl:choose>
          <xsl:when test="lower-case($operationName)='getcapabilities' and $operationName != 'GetCapabilities'">
            <ctl:message>FAIL: Operation name must be UpperCamelCase (GetCapabilities)</ctl:message>
            <ctl:fail/>
          </xsl:when>
          <xsl:when test="lower-case($operationName)='describesensor' and $operationName != 'DescribeSensor'">
            <ctl:message>FAIL: Operation name must be UpperCamelCase (DescribeSensor)</ctl:message>
            <ctl:fail/>
          </xsl:when>
          <xsl:when test="lower-case($operationName)='getobservation' and $operationName != 'GetObservation'">
            <ctl:message>FAIL: Operation name must be UpperCamelCase (GetObservation)</ctl:message>
            <ctl:fail/>
          </xsl:when>
          <xsl:when test="lower-case($operationName)='getobservationbyid' and $operationName != 'GetObservationById'">
            <ctl:message>FAIL: Operation name must be UpperCamelCase (GetObservationById)</ctl:message>
            <ctl:fail/>
          </xsl:when>
          <xsl:when test="lower-case($operationName)='getfeatureofinterest' and $operationName != 'GetFeatureOfInterest'">
            <ctl:message>FAIL: Operation name must be UpperCamelCase (GetFeatureOfInterest)</ctl:message>
            <ctl:fail/>
          </xsl:when>
          <!-- TODO: check other operation names -->
        </xsl:choose>
      </xsl:for-each>
    </ctl:code>
  </ctl:test>
  <ctl:test name="getCapabilities:IOOS-SOS.GetCapabilities-ResponseContainsValidOperationsMetadataProperty.2">
    <ctl:param name="capabilitiesDocument" />
    <ctl:assertion>The ObservationOffering for the whole network is listed, and gml:id and gml:name for that offering is in lower case</ctl:assertion>
    <ctl:code>
      <xsl:variable name="allOffering" select="$capabilitiesDocument/sos:Contents/sos:ObservationOfferingList/sos:ObservationOffering[gml:name[matches(.,'urn:ioos:network:.*?:all')]]" />
      <xsl:choose>
        <xsl:when test="not($allOffering)">
          <ctl:message>FAIL: "all" offering not found</ctl:message>
          <ctl:fail />
        </xsl:when>
        <xsl:otherwise>
          <xsl:if test="lower-case($allOffering/@gml:id) != $allOffering/@gml:id">
            <ctl:message>FAIL: "all" offering gml:id is not lowercase</ctl:message>
            <ctl:fail />
          </xsl:if>
          <xsl:if test="lower-case($allOffering/gml:name) != $allOffering/gml:name">
            <ctl:message>FAIL: "all" offering gml:name is not lowercase</ctl:message>
            <ctl:fail />
          </xsl:if>
        </xsl:otherwise>
      </xsl:choose>
    </ctl:code>
  </ctl:test>
</ctl:package>

